# E2E Tests Workflow
# Runs Docker-based end-to-end tests for the AES-Bizzy ecosystem
#
# Test Modes:
# - structural: No API keys needed, validates structure only (runs on all PRs)
# - smoke: Minimal API calls to validate connectivity (runs on PRs to main)
# - integration: Full integration tests (manual trigger or scheduled)
# - full: Complete test suite (manual trigger only)

name: E2E Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - structural
          - smoke
          - integration
          - full
  schedule:
    # Run integration tests weekly on Sunday at midnight
    - cron: '0 0 * * 0'

env:
  # Default test timeout (5 minutes)
  TEST_TIMEOUT: 300000

jobs:
  # ===========================================================================
  # Structural Tests - Always run, no secrets needed
  # ===========================================================================
  structural:
    name: Structural Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.test
          push: false
          load: true
          tags: aes-bizzy-test:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run structural tests
        run: |
          docker-compose -f docker-compose.test.yml run --rm test-runner --structural
        env:
          TEST_MODE: structural

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: structural-test-results
          path: |
            tests/e2e/results/
            coverage/
          retention-days: 7

  # ===========================================================================
  # Smoke Tests - Run on PRs to main, requires minimal secrets
  # ===========================================================================
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: structural
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.base_ref == 'main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.test_mode != 'structural')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.test
          push: false
          load: true
          tags: aes-bizzy-test:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run smoke tests
        run: |
          docker-compose -f docker-compose.test.yml run --rm test-runner --smoke
        env:
          TEST_MODE: smoke
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results
          path: |
            tests/e2e/results/
            coverage/
          retention-days: 7

  # ===========================================================================
  # Integration Tests - Run on schedule or manual trigger
  # ===========================================================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: smoke
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.test_mode == 'integration' || github.event.inputs.test_mode == 'full'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.test
          push: false
          load: true
          tags: aes-bizzy-test:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start services
        run: |
          docker-compose -f docker-compose.test.yml up -d qdrant
          # Wait for Qdrant to be healthy
          timeout 60 bash -c 'until docker-compose -f docker-compose.test.yml exec -T qdrant curl -s http://localhost:6333/health; do sleep 2; done'

      - name: Run integration tests
        run: |
          docker-compose -f docker-compose.test.yml run --rm test-runner --integration
        env:
          TEST_MODE: integration
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          REF_API_KEY: ${{ secrets.REF_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}
          MAGIC_21ST_API_KEY: ${{ secrets.MAGIC_21ST_API_KEY }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down -v

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            tests/e2e/results/
            coverage/
          retention-days: 14

  # ===========================================================================
  # Full Tests - Manual trigger only
  # ===========================================================================
  full:
    name: Full E2E Tests
    runs-on: ubuntu-latest
    needs: integration
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.test_mode == 'full'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.test
          push: false
          load: true
          tags: aes-bizzy-test:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start all services
        run: |
          docker-compose -f docker-compose.test.yml up -d qdrant
          timeout 60 bash -c 'until docker-compose -f docker-compose.test.yml exec -T qdrant curl -s http://localhost:6333/health; do sleep 2; done'

      - name: Run full test suite
        run: |
          docker-compose -f docker-compose.test.yml run --rm test-runner --full
        env:
          TEST_MODE: full
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          REF_API_KEY: ${{ secrets.REF_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}
          MAGIC_21ST_API_KEY: ${{ secrets.MAGIC_21ST_API_KEY }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down -v

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-test-results
          path: |
            tests/e2e/results/
            coverage/
          retention-days: 30

  # ===========================================================================
  # Summary Job - Report overall status
  # ===========================================================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [structural, smoke]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.structural.result }}" == "success" ]; then
            echo "✅ Structural tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Structural tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.smoke.result }}" == "success" ]; then
            echo "✅ Smoke tests passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.smoke.result }}" == "skipped" ]; then
            echo "⏭️ Smoke tests skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Smoke tests failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if critical tests failed
        if: needs.structural.result == 'failure'
        run: exit 1
