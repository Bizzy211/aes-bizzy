# =============================================================================
# A.E.S Bizzy - E2E Test Container
# =============================================================================
# Multi-stage build for efficient E2E testing with all dependencies
#
# Usage:
#   docker build -f Dockerfile.test -t aes-bizzy-test .
#   docker run --env-file .env.test aes-bizzy-test --smoke
#
# Test modes:
#   --structural   No API calls, validate structure only
#   --smoke        Minimal API calls, quick validation
#   --integration  Full API integration tests
#   --full         Complete test suite including slow tests
# =============================================================================

FROM node:20-slim AS base

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    git \
    curl \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Create Python virtual environment
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Set working directory
WORKDIR /app

# =============================================================================
# Dependencies Stage
# =============================================================================
FROM base AS dependencies

# Copy package files
COPY package*.json ./

# Install Node.js dependencies
RUN npm ci --only=production

# Copy Python requirements and install
COPY tests/hooks/requirements.txt ./tests/hooks/
RUN pip install --no-cache-dir -r tests/hooks/requirements.txt

# =============================================================================
# Test Stage
# =============================================================================
FROM dependencies AS test

# Install dev dependencies for testing
RUN npm ci

# Copy application code
COPY . .

# Build TypeScript
RUN npm run build

# Create test results directory
RUN mkdir -p /app/test-results

# Environment variables (defaults, override with --env-file)
ENV NODE_ENV=test
ENV CI=true
ENV TEST_MODE=structural
ENV LOG_LEVEL=info

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD node -e "console.log('healthy')" || exit 1

# Default entrypoint runs the E2E test script
ENTRYPOINT ["/app/tests/e2e/docker-entrypoint.sh"]

# Default to structural tests (no API calls)
CMD ["--structural"]
